<!doctype html>
<link rel="stylesheet" href="styles.css">
<html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Taco‚Äôs Serrano ¬∑ Fidelidad</title>
<meta name="theme-color" content="#FFD100"/>
<link rel="icon" href="imagotipo.png"/>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; img-src 'self' data: https: blob:; style-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://www.gstatic.com; connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://firebaseinstallations.googleapis.com https://identitytoolkit.googleapis.com https://www.gstatic.com;">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<!-- Firebase compat (no modules) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script src="config.js"></script>

</head>
<body class="min-h-screen text-gray-900">
<main class="max-w-md mx-auto p-4">
  <header class="flex items-center gap-3">
    <img src="imagotipo.png" class="w-14 h-14 bg-white rounded-2xl object-contain"/>
    <div><h1 class="text-3xl font-bold text-[#C8102E]">Taco‚Äôs Serrano</h1><p class="text-xs opacity-70">Ciudad Quesada ¬∑ 24610007</p></div>
  </header>

  <section id="dashboard" class="mt-5 card bg-white rounded-3xl p-5">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold">Centro de fidelidad</h2>
        <p class="text-sm opacity-80">Ingres√° el <b>tel√©fono</b> o <b>nombre</b> del cliente y eleg√≠ el programa.</p>
      </div>
      <button id="cashierBtn" class="btn px-4 py-2 font-semibold text-white" style="background:var(--r)">Panel de caja</button>
    </div>
    <div id="greet" class="greet mt-2 text-sm bg-[#FFF3D1] border border-[#F8D776] rounded-xl px-3 py-2">
      <span id="greetText">Bienvenido üëã</span>
      <button id="logoutBtn" class="ml-2 underline text-xs">Salir</button>
    </div>
    <div class="mt-3 flex gap-2">
      <input id="idInput" class="flex-1 border rounded-xl p-3" placeholder="e.g. 8313-7606"/>
      <button id="useIdBtn" class="btn bg-[#C8102E] text-white px-4 py-3 font-semibold">Ver tarjetas</button>
    </div>
    <div id="idHint" class="text-xs opacity-70 mt-2 hidden"></div>
    <div id="fbWarn" class="mt-2 text-xs text-red-700 hidden">‚ö†Ô∏è Firebase no est√° inicializado.</div>
    <div id="cards" class="mt-4 grid gap-3"></div>
  </section>

  <section id="detail" class="hidden mt-6 card bg-white p-5 rounded-3xl">
    <div class="flex items-center justify-between">
      <div>
        <button id="backBtn" class="text-sm underline">&larr; Volver</button>
        <div class="flex items-center gap-2 mt-1">
          <span class="badge" id="programBadge">Programa</span>
          <h3 id="progName" class="text-xl font-bold"></h3>
        </div>
        <p id="cid" class="text-xs opacity-70"></p>
      </div>
      <button id="shareBtn" class="underline text-sm">Compartir</button>
    </div>

    <div class="mt-4">
      <div class="flex items-center justify-between text-xs"><span>Progreso</span><span id="progressText" class="px-2 py-1 rounded-full bg-gray-900 text-white">0/10</span></div>
      <div class="bar mt-1"><div id="progressBar" style="width:0%"></div></div>
    </div>

    <div id="stamps" class="grid grid-cols-5 gap-1 mt-3"></div>

    <div class="mt-4 bg-gray-50 p-3 rounded-2xl">
      <div class="text-sm font-semibold">Acceso para colaboradores</div>
      <div class="text-xs opacity-70">Los botones se habilitan al iniciar sesi√≥n desde <b>Panel de caja</b>.</div>
      <div id="adminPanel" class="mt-3 grid grid-cols-2 gap-2 opacity-50 pointer-events-none">
        <button id="addBtn" class="btn px-4 py-3 font-semibold text-white" style="background:var(--r)">+1 punto</button>
        <button id="remBtn" class="btn px-4 py-3 font-semibold bg-white border">-1</button>
        <button id="redeemBtn" class="btn px-4 py-3 font-semibold" style="background:var(--y)">Registrar canje</button>
        <button id="resetBtn" class="btn px-4 py-3 font-semibold bg-white border">Reiniciar</button>
      </div>
      <div id="rewardHint" class="text-xs opacity-70 mt-3"></div>
    </div>

    <div class="mt-4">
      <div class="text-sm font-semibold mb-1">Historial</div>
      <ul id="history" class="space-y-1 max-h-36 overflow-auto pr-1 text-[12px]"></ul>
    </div>
  </section>
</main>

<!-- Modal login -->
<div id="loginModal" class="modal">
  <div class="box">
    <h3 class="text-lg font-bold">Panel de caja</h3>
    <p class="text-xs opacity-70 mb-2">Inici√° sesi√≥n con el correo y la clave que creaste en Firebase.</p>
    <div class="grid gap-2">
      <input id="email" class="rounded-xl border p-2" placeholder="caja@tacosserrano.com" />
      <input id="pass" type="password" class="rounded-xl border p-2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button id="loginBtn" class="btn px-4 py-2 font-semibold text-white" style="background:var(--r)">Entrar</button>
      <button id="closeLogin" class="text-sm underline">Cancelar</button>
    </div>
  </div>
</div>

<a class="fab" href="/">Ir al Men√∫</a>
<div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/80 text-white text-sm px-3 py-2 rounded-xl shadow-lg hidden"></div>

<script>
const ADMIN_PIN = "24610007"; // reservado por si luego lo quer√©s reactivar
const PROGRAMS = {
  economico: { n:"Men√∫ econ√≥mico", goal:10, rewards:{5:"30% de descuento (men√∫ econ√≥mico)",8:"Papas grandes gratis",10:"Men√∫ econ√≥mico gratis"}, color:getCss('--r'), tagline:"Aqu√≠ siempre te damos m√°s", thumb:"media/economico.jpg" },
  combos:    { n:"Combos",           goal:10, rewards:{5:"30% de descuento",8:"Papas grandes gratis",10:"Combo gratis"},               color:getCss('--b'), tagline:"Eleg√≠ tu combo ‚Äî cada compra suma", thumb:"media/combos.jpg" },
  deluxe:    { n:"Hamburguesas Deluxe", goal:10, rewards:{5:"30% de descuento",8:"Papas grandes gratis",10:"Deluxe gratis"},          color:getCss('--g'), tagline:"Comer rico no es caro", thumb:"media/deluxe.jpg" }
};

const $ = s=>document.querySelector(s);
const qs = new URLSearchParams(location.search);
let programKey = qs.get('program') || "";
let customerId = (qs.get('id')||"").trim();
let isAuthed = false, currentUserEmail = "";

const dashboard = $("#dashboard"), cardsWrap = $("#cards"), idInput=$("#idInput"), useIdBtn=$("#useIdBtn"), idHint=$("#idHint");
const detail = $("#detail"), backBtn=$("#backBtn"), progName=$("#progName"), programBadge=$("#programBadge"), cid=$("#cid");
const progressText=$("#progressText"), progressBar=$("#progressBar"), stamps=$("#stamps"), rewardHint=$("#rewardHint");
const adminPanel=$("#adminPanel");
const historyUl=$("#history"); const fbWarn=$("#fbWarn");
const loginModal=$("#loginModal"), cashierBtn=$("#cashierBtn"), closeLogin=$("#closeLogin");
const email=$("#email"), pass=$("#pass"), loginBtn=$("#loginBtn"), greet=$("#greet"), greetText=$("#greetText"), logoutBtn=$("#logoutBtn");
const toast=$("#toast");

function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function toastMsg(m){ toast.textContent=m; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),1600); }
function fmtDate(d=new Date()){ return d.toLocaleString(undefined,{dateStyle:'medium', timeStyle:'short'}); }

// Firebase init + persistence
let db=null, auth=null;
try {
  firebase.initializeApp(window.firebaseConfig);
  db = firebase.firestore();
  auth = firebase.auth();
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); // recordar sesi√≥n
  auth.onAuthStateChanged(u=>{
    isAuthed = !!u;
    currentUserEmail = u && u.email || "";
    updateAuthUI();
  });
} catch (e) {
  console.warn("Firebase no inicializado:", e);
  fbWarn.classList.remove('hidden');
}

function updateAuthUI(){
  if (isAuthed){
    greet.style.display = "block";
    greetText.textContent = "Bienvenido, " + (currentUserEmail.split("@")[0].replace(/\./g," ").replace(/^\w/, c=>c.toUpperCase())) + " üëã";
    adminPanel.classList.remove("pointer-events-none"); adminPanel.classList.remove("opacity-50");
  } else {
    greet.style.display = "none";
    adminPanel.classList.add("pointer-events-none"); adminPanel.classList.add("opacity-50");
  }
}

cashierBtn.onclick = ()=> { loginModal.style.display = "grid"; email.focus(); };
closeLogin.onclick = ()=> { loginModal.style.display = "none"; };
loginBtn.onclick = async ()=>{
  try{
    await auth.signInWithEmailAndPassword(email.value.trim(), pass.value);
    loginModal.style.display = "none";
    toastMsg("Sesi√≥n iniciada");
  }catch(e){ console.error(e); toastMsg("Error al iniciar sesi√≥n"); }
};
logoutBtn.onclick = async ()=>{ try{ await auth.signOut(); toastMsg("Sesi√≥n cerrada"); }catch(e){} };

function keyDoc(p,id){ return db.collection('fidelidad').doc(`${p}__${id}`); }
async function loadRemote(p,id){ if (!db||!id) return {points:0,history:[]}; const s=await keyDoc(p,id).get(); return s.exists? s.data() : {points:0,history:[]}; }
async function saveRemote(p,id,payload){ if (!db||!id) throw 0; if (!isAuthed){ toastMsg("Inici√° sesi√≥n en Panel de caja"); throw 0; } await keyDoc(p,id).set(payload,{merge:true}); }
let unsub=null; function listenRemote(p,id,onChange){ if(!db||!id) return ()=>{}; if (unsub) unsub(); unsub = keyDoc(p,id).onSnapshot(s=> onChange(s.exists? s.data() : {points:0,history:[]})); return unsub; }

function cardTemplate(p, pts=0){
  const prog = PROGRAMS[p];
  return `<div class="cardItem rounded-2xl border p-4 flex items-center gap-3">
    <img src="${prog.thumb}" class="thumb" alt="${prog.n}"/>
    <div class="flex-1">
      <div class="text-[11px] opacity-70">${customerId||"Sin ID"}</div>
      <div class="font-semibold">${prog.n}</div>
      <div class="tagline text-xs">${prog.tagline}</div>
      <div class="text-xs mt-1">${pts}/${prog.goal} sellos</div>
    </div>
    <button class="btn px-3 py-2 text-white font-semibold" style="background:${prog.color}" data-open="${p}">Ver</button>
  </div>`;
}

async function renderDashboard(){
  dashboard.classList.remove("hidden"); detail.classList.add("hidden");
  let html = "";
  for (const p of ["economico","combos","deluxe"]){
    const s = customerId ? await loadRemote(p, customerId) : {points:0};
    html += cardTemplate(p, s.points||0);
  }
  cardsWrap.innerHTML = html;
  if (customerId){ idHint.classList.remove("hidden"); idHint.textContent = "Mostrando tarjetas para: " + customerId; } else { idHint.classList.add("hidden"); }
  cardsWrap.querySelectorAll("button[data-open]").forEach(btn=> btn.addEventListener("click", ()=> openDetail(btn.getAttribute("data-open"))));
}

function renderStamps(state){
  const pts = state.points||0;
  const goal = PROGRAMS[programKey].goal;
  progressText.textContent = `${pts}/${goal}`;
  progressBar.style.width = `${(pts*100/goal)}%`;
  stamps.innerHTML="";
  for (let i=0;i<goal;i++){
    const d=document.createElement('div'); d.className='stamp h-12';
    const isMilestone = (i===4)||(i===7)||(i===9);
    if (i<pts){ d.classList.add('filled'); d.textContent = (programKey==='economico') ? 'TS' : (programKey==='combos' ? 'üçüü•§' : 'üçî'); }
    else if (isMilestone){ const label = (i===4)?'30%':(i===7)?'Papas grandes':'Producto gratis'; d.innerHTML=`<div class='text-[10px] leading-tight'>${label}</div>`; }
    else { d.textContent = i+1; }
    stamps.appendChild(d);
  }
  rewardHint.textContent = "Premios: " + Object.entries(PROGRAMS[programKey].rewards).map(([k,v])=> "#" + k + " " + v).join(" ¬∑ ");
  // history
  historyUl.innerHTML = (state.history||[]).map(h=> `<li>‚Ä¢ ${h.type||h.change||'?'} ‚Äî ${h.at||h.timestamp||''}</li>`).join("");
}

async function openDetail(p){
  if (!customerId){ toastMsg("Ingres√° un ID arriba primero"); return; }
  programKey = p;
  const params = new URLSearchParams(); params.set("program", programKey); params.set("id", customerId);
  history.replaceState(null,"","?"+params.toString());
  dashboard.classList.add("hidden"); detail.classList.remove("hidden");
  const prog = PROGRAMS[programKey];
  programBadge.textContent = programKey; progName.textContent = prog.n; cid.textContent = customerId;
  const state = await loadRemote(programKey, customerId); renderStamps(state);
  listenRemote(programKey, customerId, (st)=> renderStamps(st));
}

// Admin actions (require auth)
addBtn.onclick = async ()=>{ const s=await loadRemote(programKey, customerId); const next=Math.min(PROGRAMS[programKey].goal,(s.points||0)+1); await saveRemote(programKey, customerId, { points: next, history:[{type:'+1',at:fmtDate()},...(s.history||[])] }); };
remBtn.onclick = async ()=>{ const s=await loadRemote(programKey, customerId); const next=Math.max(0,(s.points||0)-1); await saveRemote(programKey, customerId, { points: next, history:[{type:'-1',at:fmtDate()},...(s.history||[])] }); };
redeemBtn.onclick = async ()=>{ const s=await loadRemote(programKey, customerId); const goal=PROGRAMS[programKey].goal; const nextPts=((s.points||0)>=goal)?0:(s.points||0); await saveRemote(programKey, customerId, { points: nextPts, history:[{type:'canje',at:fmtDate()},...(s.history||[])] }); };
resetBtn.onclick = async ()=>{ await saveRemote(programKey, customerId, { points:0, history:[{type:'reset',at:fmtDate()}] }); };

useIdBtn.onclick = ()=>{ customerId = idInput.value.trim(); if (!customerId) return toastMsg("Ingres√° un ID"); renderDashboard(); };
backBtn.onclick = ()=>{ const p=new URLSearchParams(); if(customerId) p.set('id',customerId); history.replaceState(null,'','?'+p.toString()); renderDashboard(); };

if (customerId){ idInput.value = customerId; }
if (programKey && customerId){ openDetail(programKey); } else { renderDashboard(); }
</script>

<!-- BOT√ìN VOLVER AL MEN√ö -->
<a href="/" 
   style="position:fixed;left:16px;top:16px;background:#FFD100;color:#111;
          padding:10px 14px;border-radius:14px;font-weight:700;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          box-shadow:0 6px 16px rgba(0,0,0,.18);text-decoration:none;z-index:9999;">
  üè† Volver al Men√∫
</a>
<!-- /FIN BOT√ìN VOLVER -->

</body></html>
